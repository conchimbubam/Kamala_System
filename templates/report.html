<div class="modal fade" id="hkReportModal" tabindex="-1" aria-labelledby="hkReportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="hkReportModalLabel">
                    <i class="fas fa-file-alt me-2"></i>Báo cáo Housekeeping
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body bg-light">
                <div class="paper-sheet mx-auto bg-white p-5 shadow-sm" style="max-width: 210mm; min-height: 297mm;">
                    
                    <div class="text-center mb-4">
                        <h3 class="text-uppercase fw-bold mb-3">BÁO CÁO TỔNG HỢP HOẠT ĐỘNG BUỒNG PHÒNG</h3>
                        <p class="mb-1">Ngày báo cáo: <span id="report-date-display" class="fw-bold">--/--/----</span></p>
                        <p class="text-muted fst-italic"><small>Thời gian xuất: <span id="report-time"></span></small></p>
                    </div>

                    <div class="row mb-4 border-top border-bottom py-3">
                        <div class="col-6 text-center border-end">
                            <h5 class="mb-0">Tổng nhân viên tham gia</h5>
                            <span class="display-6 fw-bold text-primary" id="total-staff-working">0</span>
                        </div>
                        <div class="col-6 text-center">
                            <h5 class="mb-0">Tổng số phòng đã xử lý</h5>
                            <span class="display-6 fw-bold text-success" id="total-rooms-cleaned">0</span>
                        </div>
                    </div>

                    <div class="report-section">
                        <h5 class="mb-3 text-decoration-underline">Chi tiết thực hiện theo nhân viên:</h5>
                        <div class="table-responsive">
                            <table class="table table-bordered border-dark table-sm align-middle" id="print-table">
                                <thead class="table-light border-dark">
                                    <tr class="text-center align-middle">
                                        <th style="width: 15%">Nhân viên</th>
                                        <th style="width: 20%">Phân loại</th>
                                        <th style="width: 10%">Số lượng</th>
                                        <th style="width: 55%">Chi tiết (Số phòng)</th>
                                    </tr>
                                </thead>
                                <tbody id="hk-report-body">
                                    <tr>
                                        <td colspan="4" class="text-center py-4 text-muted">
                                            <i class="fas fa-spinner fa-spin me-2"></i>Đang tải dữ liệu báo cáo...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="mt-4 pt-3 border-top small text-muted">
                        <div class="row">
                            <div class="col-12">
                                <strong>Ghi chú phân loại:</strong>
                                <span class="me-3">VD (Phòng trống sạch)</span>
                                <span class="me-3">OD (Phòng ở)</span>
                                <span class="me-3">DND (Không làm phiền)</span>
                                <span>NN (Không cần dọn)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Đóng
                </button>
                <button type="button" class="btn btn-primary" onclick="window.print()">
                    <i class="fas fa-print me-2"></i>In báo cáo
                </button>
                <button type="button" class="btn btn-success" onclick="exportHKReport()">
                    <i class="fas fa-file-excel me-2"></i>Xuất Excel
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    @media print {
        body * {
            visibility: hidden;
        }
        #hkReportModal, #hkReportModal .modal-dialog, #hkReportModal .modal-content, #hkReportModal .modal-body {
            visibility: visible;
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            margin: 0;
            padding: 0;
            border: none;
            background: white;
        }
        .modal-header, .modal-footer, .btn-close {
            display: none !important;
        }
        .paper-sheet {
            box-shadow: none !important;
            padding: 0 !important;
            max-width: 100% !important;
        }
    }
</style>

<script>
    // Hàm này giả định bạn có hàm loadData gốc, hãy thay thế nội dung bên trong hàm render
    // để biến đổi dữ liệu phẳng thành dữ liệu phân tầng.
    
    function renderReportTable(logData) {
        // logData: Array các object từ database { staffName, roomNo, actionType, ... }
        
        // 1. Tổng hợp dữ liệu
        const staffGroups = {};
        let totalRooms = 0;
        const allStaff = new Set();

        logData.forEach(log => {
            const staff = log.staffName || 'Unknown';
            const room = log.roomNo;
            // Mapping loại thao tác từ code sang text hiển thị (Tuỳ chỉnh theo DB của bạn)
            let type = log.actionType; 
            if(type.includes('VD')) type = 'Dọn phòng trống (VD)';
            else if(type.includes('OD')) type = 'Dọn phòng ở (OD)';
            else if(type.includes('DND')) type = 'DND';
            else if(type.includes('NN')) type = 'NN';

            allStaff.add(staff);
            totalRooms++;

            if (!staffGroups[staff]) {
                staffGroups[staff] = {};
            }
            if (!staffGroups[staff][type]) {
                staffGroups[staff][type] = [];
            }
            staffGroups[staff][type].push(room);
        });

        // 2. Cập nhật số liệu tổng quan
        document.getElementById('total-staff-working').innerText = allStaff.size;
        document.getElementById('total-rooms-cleaned').innerText = totalRooms;
        document.getElementById('report-date-display').innerText = new Date().toLocaleDateString('vi-VN');
        document.getElementById('report-time').innerText = new Date().toLocaleTimeString('vi-VN');

        // 3. Render Bảng HTML
        const tbody = document.getElementById('hk-report-body');
        tbody.innerHTML = '';

        if (Object.keys(staffGroups).length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center">Không có dữ liệu</td></tr>';
            return;
        }

        // Duyệt từng nhân viên
        for (const [staffName, actions] of Object.entries(staffGroups)) {
            const actionTypes = Object.keys(actions);
            const totalRows = actionTypes.length;

            actionTypes.forEach((type, index) => {
                const rooms = actions[type];
                const tr = document.createElement('tr');

                // Cột Nhân viên (chỉ hiện ở dòng đầu tiên của nhân viên đó - Rowspan)
                if (index === 0) {
                    const tdStaff = document.createElement('td');
                    tdStaff.rowSpan = totalRows;
                    tdStaff.className = 'fw-bold bg-white align-top';
                    tdStaff.innerText = staffName;
                    tr.appendChild(tdStaff);
                }

                // Cột Phân loại
                const tdType = document.createElement('td');
                tdType.innerText = type;
                tr.appendChild(tdType);

                // Cột Số lượng
                const tdQty = document.createElement('td');
                tdQty.className = 'text-center fw-bold';
                tdQty.innerText = rooms.length;
                tr.appendChild(tdQty);

                // Cột Chi tiết
                const tdDetail = document.createElement('td');
                tdDetail.innerText = rooms.join(', ');
                tr.appendChild(tdDetail);

                tbody.appendChild(tr);
            });
        }
    }
</script>