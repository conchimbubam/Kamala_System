name: üöÄ Gi·ªØ Kamala System Alive

on:
  schedule:
    # Ch·∫°y m·ªói 14 ph√∫t (Render sleep sau 15p -> 14p l√† t·ªëi ∆∞u nh·∫•t)
    # Ch·∫°y 24/7 ƒë·ªÉ ƒë·∫£m b·∫£o h·ªá th·ªëng lu√¥n s·∫µn s√†ng
    - cron: '*/14 * * * *'
  workflow_dispatch: # Cho ph√©p ch·∫°y th·ªß c√¥ng
  push:
    branches: [ main ] # Ch·∫°y khi c√≥ code m·ªõi (t√πy ch·ªçn)

jobs:
  keep-awake:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: ‚è∞ Hi·ªÉn th·ªã th·ªùi gian
        run: |
          echo "Th·ªùi gian h·ªá th·ªëng (UTC): $(date -u '+%H:%M %d/%m/%Y')"
          echo "Th·ªùi gian Vi·ªát Nam (GMT+7): $(TZ='Asia/Ho_Chi_Minh' date '+%H:%M %d/%m/%Y')"
          echo "---"

      - name: üì° Ping Kamala System
        run: |
          # C·∫•u h√¨nh URL
          APP_URL="https://kamala-system.onrender.com/api/health"
          echo "üåê ƒêang ping ƒë·∫øn: $APP_URL"
          
          # G·ª≠i request v√† l∆∞u response + status code
          # -s: Silent (kh√¥ng hi·ªán thanh ti·∫øn tr√¨nh)
          # -w: Write out (ghi status code ra cu·ªëi)
          # --max-time: Timeout 30s
          HTTP_CODE=$(curl -s -o response.json -w "%{http_code}" --max-time 30 "$APP_URL")
          
          echo "M√£ ph·∫£n h·ªìi HTTP: $HTTP_CODE"
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "‚úÖ K·∫øt n·ªëi th√†nh c√¥ng!"
            
            # S·ª≠ d·ª•ng jq ƒë·ªÉ parse JSON (nhanh v√† chu·∫©n h∆°n Python trong bash)
            echo "üìä Th√¥ng tin chi ti·∫øt:"
            if [ -s response.json ]; then
              jq '.' response.json || echo "‚ö†Ô∏è JSON kh√¥ng h·ª£p l·ªá"
            else
              echo "‚ö†Ô∏è Response r·ªóng"
            fi
            
          else
            echo "‚ö†Ô∏è L·ªói k·∫øt n·ªëi ho·∫∑c App ƒëang ng·ªß (Code: $HTTP_CODE)"
            echo "üîÑ ƒêang th·ª≠ ƒë√°nh th·ª©c l·∫°i sau 15 gi√¢y..."
            sleep 15
            
            # Th·ª≠ l·∫°i l·∫ßn 2
            HTTP_CODE_2=$(curl -s -o /dev/null -w "%{http_code}" --max-time 45 "$APP_URL")
            
            if [ "$HTTP_CODE_2" -eq 200 ]; then
              echo "‚úÖ App ƒë√£ t·ªânh d·∫≠y th√†nh c√¥ng ·ªü l·∫ßn th·ª≠ th·ª© 2!"
            else
              echo "‚ùå Th·∫•t b·∫°i: Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi Kamala System"
              exit 1
            fi
          fi

      - name: ‚úÖ K·∫øt th√∫c
        if: success()
        run: |
          echo "=========================================="
          echo "‚ú® HO√ÄN T·∫§T - $(TZ='Asia/Ho_Chi_Minh' date '+%H:%M %d/%m/%Y')"
          echo "‚úÖ Kamala System ƒë√£ ƒë∆∞·ª£c gi·ªØ alive"
          echo "=========================================="
