name: üöÄ Gi·ªØ Kamala System Alive
on:
  # L·ªãch tr√¨nh: m·ªói 5 ph√∫t t·ª´ 1h-9h UTC (8h-16h GMT+7)
  schedule:
    - cron: '*/5 1-9 * * *'
  
  # Cho ph√©p ch·∫°y th·ªß c√¥ng
  workflow_dispatch:
  
  # T·ª± ch·∫°y khi c√≥ code m·ªõi
  push:
    branches: [ main ]

jobs:
  keep-awake:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: ‚è∞ Hi·ªÉn th·ªã th·ªùi gian
      run: |
        echo "Th·ªùi gian h·ªá th·ªëng (UTC): $(date -u '+%H:%M %d/%m/%Y')"
        echo "Th·ªùi gian Vi·ªát Nam (GMT+7): $(TZ='Asia/Ho_Chi_Minh' date '+%H:%M %d/%m/%Y')"
        echo "---"
    
    - name: üì° Ping Kamala System
      run: |
        # URL C·ª¶A B·∫†N - ƒê√É ƒê∆Ø·ª¢C ƒêI·ªÄN S·∫¥N
        APP_URL="https://kamala-system.onrender.com/api/health"
        
        echo "üåê ƒêang ping ƒë·∫øn: $APP_URL"
        echo ""
        
        # L·∫ßn th·ª≠ 1
        echo "üîÑ L·∫ßn th·ª≠ 1..."
        RESPONSE_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 45 "$APP_URL")
        
        if [ "$RESPONSE_CODE" -eq 200 ]; then
          echo "‚úÖ Th√†nh c√¥ng! M√£: $RESPONSE_CODE"
          
          # L·∫•y th√¥ng tin chi ti·∫øt
          echo ""
          echo "üìä Th√¥ng tin chi ti·∫øt:"
          curl -s --max-time 45 "$APP_URL" | python3 -c "
import json, sys
try:
    data = json.load(sys.stdin)
    print(f'Status: {data.get(\"status\", \"N/A\")}')
    print(f'Service: {data.get(\"service\", \"N/A\")}')
    print(f'Database: {data.get(\"database\", \"N/A\")}')
    print(f'Time: {data.get(\"timestamp\", \"N/A\")}')
except:
    print('Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c JSON')
          "
        else
          echo "‚ö†Ô∏è L·∫ßn 1 th·∫•t b·∫°i: M√£ $RESPONSE_CODE"
          echo ""
          
          # ƒê·ª£i 15 gi√¢y ƒë·ªÉ app wake up
          echo "‚è≥ ƒê·ª£i 15 gi√¢y ƒë·ªÉ app wake up..."
          sleep 15
          
          # L·∫ßn th·ª≠ 2
          echo "üîÑ L·∫ßn th·ª≠ 2..."
          RESPONSE_CODE_2=$(curl -s -o /dev/null -w "%{http_code}" --max-time 60 "$APP_URL")
          
          if [ "$RESPONSE_CODE_2" -eq 200 ]; then
            echo "‚úÖ Th√†nh c√¥ng ·ªü l·∫ßn 2! M√£: $RESPONSE_CODE_2"
          else
            echo "‚ùå Th·∫•t b·∫°i c·∫£ 2 l·∫ßn"
            echo "M√£ cu·ªëi: $RESPONSE_CODE_2"
            echo ""
            echo "üîç Nguy√™n nh√¢n c√≥ th·ªÉ:"
            echo "   1. App ƒëang b·ªã l·ªói"
            echo "   2. URL kh√¥ng ƒë√∫ng"
            echo "   3. Qu√° th·ªùi gian ch·ªù"
            exit 1
          fi
        fi
    
    - name: ‚úÖ K·∫øt th√∫c
      if: success()
      run: |
        echo ""
        echo "=========================================="
        echo "‚ú® HO√ÄN T·∫§T - $(TZ='Asia/Ho_Chi_Minh' date '+%H:%M %d/%m/%Y')"
        echo "‚úÖ Kamala System ƒë√£ ƒë∆∞·ª£c gi·ªØ alive"
        echo "‚è∞ L·∫ßn ch·∫°y ti·∫øp theo: sau 5 ph√∫t"
        echo "=========================================="
