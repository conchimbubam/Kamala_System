name: üöÄ Gi·ªØ Kamala System Alive
on:
  schedule:
    - cron: '*/5 1-9 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  keep-awake:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: ‚è∞ Hi·ªÉn th·ªã th·ªùi gian
      run: |
        echo "Th·ªùi gian h·ªá th·ªëng (UTC): $(date -u '+%H:%M %d/%m/%Y')"
        echo "Th·ªùi gian Vi·ªát Nam (GMT+7): $(TZ='Asia/Ho_Chi_Minh' date '+%H:%M %d/%m/%Y')"
        echo "---"
    
    - name: üì° Ping Kamala System
      run: |
        APP_URL="https://kamala-system.onrender.com/api/health"
        
        echo "üåê ƒêang ping ƒë·∫øn: $APP_URL"
        echo ""
        
        # L·∫•y response
        RESPONSE=$(curl -s --max-time 45 "$APP_URL")
        RESPONSE_CODE=$?
        
        if [ $RESPONSE_CODE -eq 0 ]; then
          echo "‚úÖ K·∫øt n·ªëi th√†nh c√¥ng!"
          
          # Parse JSON b·∫±ng Python (c√°ch vi·∫øt ƒë√∫ng)
          python3 << EOF
import json
import sys

try:
    data = json.loads('''$RESPONSE''')
    print("üìä Th√¥ng tin chi ti·∫øt:")
    print(f"Status: {data.get('status', 'N/A')}")
    print(f"Service: {data.get('service', 'N/A')}")
    print(f"Database: {data.get('database', 'N/A')}")
    print(f"Time: {data.get('timestamp', 'N/A')}")
except Exception as e:
    print(f"‚ö†Ô∏è Kh√¥ng parse ƒë∆∞·ª£c JSON: {e}")
    print("Raw response:")
    print('''$RESPONSE''')
EOF
        else
          echo "‚ö†Ô∏è L·ªói k·∫øt n·ªëi. M√£: $RESPONSE_CODE"
          echo ""
          echo "üîÑ Th·ª≠ l·∫°i sau 15 gi√¢y..."
          sleep 15
          
          RESPONSE_2=$(curl -s --max-time 60 "$APP_URL")
          RESPONSE_CODE_2=$?
          
          if [ $RESPONSE_CODE_2 -eq 0 ]; then
            echo "‚úÖ Th√†nh c√¥ng ·ªü l·∫ßn th·ª≠ th·ª© 2!"
          else
            echo "‚ùå Th·∫•t b·∫°i c·∫£ 2 l·∫ßn"
            exit 1
          fi
        fi
    
    - name: ‚úÖ K·∫øt th√∫c
      if: success()
      run: |
        echo ""
        echo "=========================================="
        echo "‚ú® HO√ÄN T·∫§T - $(TZ='Asia/Ho_Chi_Minh' date '+%H:%M %d/%m/%Y')"
        echo "‚úÖ Kamala System ƒë√£ ƒë∆∞·ª£c gi·ªØ alive"
        echo "=========================================="
